<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Highgate Avenue - Muswell Hill Products</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20260209">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}?v=20260207">
    <style>
        .mwh-product-card {
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
        }
        .mwh-product-card .product-tile {
            flex: 1;
            min-height: 0;
        }
        .mwh-product-card.x-removed { opacity: 0.65; }
        .mwh-product-flags {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.5rem;
            padding: 0.5rem 0 0;
            flex-wrap: nowrap;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        .mwh-product-flags label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .mwh-product-flags input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }
        .mwh-edit-product {
            margin-left: auto;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray-dark, #666);
            background: transparent;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        .mwh-edit-product:hover {
            border-color: #000;
            color: #000;
        }
        .mwh-edit-product:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .mwh-section { margin-bottom: 2.5rem; }
        .mwh-section:first-child { margin-top: 0; }
        .mwh-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            padding-right: 2rem;
            border-bottom: 2px solid #000;
            color: #000;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: opacity 0.2s ease;
        }
        .mwh-section-title:hover {
            opacity: 0.7;
        }
        .mwh-section-title::after {
            content: '▼';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            transition: transform 0.2s ease;
        }
        .mwh-section-title.collapsed::after {
            transform: translateY(-50%) rotate(-90deg);
        }
        .mwh-section-grid {
            transition: max-height 0.3s ease, opacity 0.2s ease, margin-bottom 0.3s ease;
            overflow: hidden;
            max-height: 5000px; /* Large enough for most sections */
        }
        .mwh-section.collapsed .mwh-section-grid {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding: 0;
        }
        .mwh-section.collapsed {
            margin-bottom: 1rem;
        }
        .mwh-section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
            align-items: start;
        }
        .product-tile-image-wrap {
            position: relative;
        }
        .mwh-product-remove-btn,
        .mwh-product-edit-btn {
            position: absolute;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #000;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .product-tile-image-wrap:hover .mwh-product-remove-btn,
        .product-tile-image-wrap:hover .mwh-product-edit-btn,
        .mwh-product-remove-btn:hover,
        .mwh-product-edit-btn:hover,
        .mwh-product-remove-btn:focus,
        .mwh-product-edit-btn:focus {
            opacity: 1;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        .mwh-product-remove-btn {
            top: 0.5rem;
            left: 0.5rem;
        }
        .mwh-product-remove-btn:hover {
            background: #fff;
            border-color: #d32f2f;
            color: #d32f2f;
            transform: scale(1.1);
        }
        .mwh-product-edit-btn {
            top: 0.5rem;
            right: 0.5rem;
        }
        .mwh-product-edit-btn:hover {
            background: #fff;
            border-color: #000;
            color: #000;
            transform: scale(1.1);
        }
        .mwh-product-remove-btn svg,
        .mwh-product-edit-btn svg {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }
        @media (max-width: 768px) {
            .mwh-product-remove-btn,
            .mwh-product-edit-btn {
                opacity: 1;
                width: 36px;
                height: 36px;
                background: rgba(255, 255, 255, 0.98);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }
            .mwh-product-remove-btn svg,
            .mwh-product-edit-btn svg {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        {% include '_sidebar.html' %}
        <main class="main-with-sidebar">
            <div class="container">
                <header>
                    <h1>Muswell Hill – Products</h1>
                    <p class="subtitle">MWH products only (is_mwh or tag <strong>mwh</strong>), grouped by category. Removed and bought items are hidden from the main sections.</p>
                    <button type="button" id="mwhAddProductBtn" class="upload-btn" style="margin-top: 1rem;"><span>+ Add Product</span></button>
                </header>
            <!-- Add Product Modal -->
            <div id="mwhProductModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal close-mwh-product-modal" aria-label="Close">&times;</span>
                    <h2 id="mwhProductModalTitle">Add Product</h2>
                    <form id="mwhProductForm">
                        <div class="form-group">
                            <label for="mwhProductLink">Product link (e.g. Amazon, Gumtree) *</label>
                            <input type="url" id="mwhProductLink" name="link" placeholder="https://..." required>
                            <button type="button" id="mwhFetchPreviewBtn" class="btn-fetch-preview" style="margin-top: 0.5rem;" title="Fill title, image, price and site from the link">Fetch from link</button>
                        </div>
                        <div class="form-group">
                            <label for="mwhProductWebsiteName">Website name</label>
                            <input type="text" id="mwhProductWebsiteName" name="website_name" placeholder="e.g. Amazon, IKEA">
                        </div>
                        <div class="form-group">
                            <label for="mwhProductTitle">Title</label>
                            <input type="text" id="mwhProductTitle" name="title" placeholder="Product name">
                        </div>
                        <div class="form-group">
                            <label for="mwhProductImageUrl">Image URL</label>
                            <input type="url" id="mwhProductImageUrl" name="image_url" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="mwhProductPrice">Price</label>
                            <input type="text" id="mwhProductPrice" name="price" placeholder="e.g. £24.99">
                        </div>
                        <div class="form-group">
                            <label for="mwhProductCategory">Category</label>
                            <select id="mwhProductCategory" name="category">
                                <option value="">—</option>
                                <option value="Appliance">Appliance</option>
                                <option value="Art">Art</option>
                                <option value="Baby">Baby</option>
                                <option value="Bathroom">Bathroom</option>
                                <option value="Decor">Decor</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Kitchen">Kitchen</option>
                                <option value="Lighting">Lighting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mwhProductRoom">Room</label>
                            <select id="mwhProductRoom" name="room">
                                <option value="">—</option>
                                <option value="Front Room">Front Room</option>
                                <option value="Bedroom">Bedroom</option>
                                <option value="Kitchen">Kitchen</option>
                                <option value="Bathroom">Bathroom</option>
                                <option value="Nursery">Nursery</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mwhProductTags">Tags (comma-separated)</label>
                            <input type="text" id="mwhProductTags" name="tags" placeholder="e.g. mwh">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="mwhProductIsMwh" name="is_mwh" value="1">
                                <span>Is MWH (show on this page)</span>
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" id="mwhCancelProduct">Cancel</button>
                            <button type="submit" class="btn-submit" id="mwhSubmitProduct">Add Product</button>
                        </div>
                        <input type="hidden" id="mwhEditingProductId" value="">
                    </form>
                    <div id="mwhProductStatus" class="upload-status" style="display: none;"></div>
                </div>
            </div>
                <div id="mwhProductsLoading" class="loading">Loading products...</div>
                <div id="mwhProductsGrid">
                    <!-- Filled by JS: sections with subheaders + product grids -->
                </div>
            </div>
        </main>
    </div>
    <script>
        (function() {
            function escapeHtml(s) {
                if (s == null) return '';
                return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }
            function getWebsiteDisplay(p) {
                if (p.website_name && p.website_name.trim()) return p.website_name.trim();
                if (p.link && p.link.includes('amazon')) return 'Amazon';
                return '';
            }
            function updateProductFlag(productId, field, value) {
                fetch('/api/products/' + productId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                }).then(function(r) {
                    if (!r.ok) console.error('Failed to update product', productId, field, value);
                }).catch(function(e) { console.error(e); });
            }
            const loading = document.getElementById('mwhProductsLoading');
            const grid = document.getElementById('mwhProductsGrid');
            const modal = document.getElementById('mwhProductModal');
            const form = document.getElementById('mwhProductForm');
            const statusEl = document.getElementById('mwhProductStatus');

            function getProductCategoryKey(p) {
                var cat = (p.category || '').trim();
                return cat || 'Uncategorised';
            }
            function renderCard(p) {
                var hasImage = p.image_url && p.image_url.trim();
                var imgHtml = hasImage ? '<img src="' + escapeHtml(p.image_url) + '" alt="' + escapeHtml(p.title || 'Product') + '" class="product-tile-image" loading="lazy" onerror="this.parentElement.classList.add(\'product-tile-image--failed\')">' : '';
                var title = escapeHtml(p.title || 'Product');
                var rawPrice = (p.price && p.price.trim()) ? p.price.trim() : '';
                var displayPrice = rawPrice && !rawPrice.startsWith('£') ? '£ ' + escapeHtml(rawPrice) : escapeHtml(rawPrice);
                var price = rawPrice ? '<span class="product-tile-price">' + displayPrice + '</span>' : '';
                var websiteDisplay = getWebsiteDisplay(p);
                var websiteHtml = websiteDisplay ? '<span class="product-tile-website">' + escapeHtml(websiteDisplay) + '</span>' : '';
                var link = (p.link && p.link.trim()) ? escapeHtml(p.link) : '#';
                var bokLikes = !!p.bok_likes;
                var xRemove = !!p.x_remove;
                var bought = !!p.bought;
                var cardClass = 'mwh-product-card' + (xRemove ? ' x-removed' : '');
                var id = p.id;
                var removeBtn = '<button type="button" class="mwh-product-remove-btn" data-id="' + id + '" title="Delete product" aria-label="Delete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>';
                var editBtn = '<button type="button" class="mwh-product-edit-btn" data-id="' + id + '" title="Edit product" aria-label="Edit"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>';
                return '<div class="' + cardClass + '" data-product-id="' + id + '"><div class="product-tile"><a href="' + link + '" target="_blank" rel="noopener noreferrer" class="product-tile-link"><div class="product-tile-image-wrap">' + imgHtml + removeBtn + editBtn + '</div><div class="product-tile-info">' + websiteHtml + '<span class="product-tile-title">' + title + '</span>' + price + '</div></a></div><div class="mwh-product-flags"><label><input type="checkbox" class="mwh-bok-likes" data-id="' + id + '" ' + (bokLikes ? 'checked' : '') + '> Bok likes</label><label><input type="checkbox" class="mwh-bought" data-id="' + id + '" ' + (bought ? 'checked' : '') + '> Bought</label></div></div>';
            }
            function renderProductList(list) {
                if (list.length === 0) {
                    grid.innerHTML = '<p class="subtitle">No MWH products yet. Add products with tag <strong>mwh</strong> or check Is MWH, and set a category to see them grouped.</p>';
                    return;
                }

                var boughtItems = list.filter(function(p) { return !!p.bought; });
                var activeItems = list.filter(function(p) { return !p.bought && !p.x_remove; });
                if (activeItems.length === 0 && boughtItems.length === 0) {
                    grid.innerHTML = '<p class="subtitle">No active products to show.</p>';
                    return;
                }

                var byCategory = {};
                activeItems.forEach(function(p) {
                    var key = getProductCategoryKey(p);
                    if (!byCategory[key]) byCategory[key] = [];
                    byCategory[key].push(p);
                });
                var categoryOrder = Object.keys(byCategory).sort(function(a, b) {
                    if (a === 'Uncategorised') return 1;
                    if (b === 'Uncategorised') return -1;
                    return a.localeCompare(b);
                });
                var html = '';
                categoryOrder.forEach(function(cat) {
                    var productsInSection = byCategory[cat];
                    if (!productsInSection.length) return;
                    html += '<div class="mwh-section"><h2 class="mwh-section-title" data-section="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</h2><div class="mwh-section-grid">';
                    productsInSection.forEach(function(p) { html += renderCard(p); });
                    html += '</div></div>';
                });
                if (boughtItems.length) {
                    html += '<div class="mwh-section"><h2 class="mwh-section-title" data-section="bought">Bought</h2><div class="mwh-section-grid">';
                    boughtItems.forEach(function(p) { html += renderCard(p); });
                    html += '</div></div>';
                }
                grid.innerHTML = html;
                grid.querySelectorAll('.mwh-bok-likes').forEach(function(cb) {
                    cb.addEventListener('change', function() { updateProductFlag(cb.dataset.id, 'bok_likes', cb.checked); });
                });
                grid.querySelectorAll('.mwh-bought').forEach(function(cb) {
                    cb.addEventListener('change', function() {
                        updateProductFlag(cb.dataset.id, 'bought', cb.checked);
                        // Re-fetch and re-render so item moves between sections immediately
                        fetch('/api/muswell-hill-products')
                            .then(function(r) { return r.json(); })
                            .then(function(products) {
                                var list = Array.isArray(products) ? products : (products && Array.isArray(products.data) ? products.data : []);
                                renderProductList(list);
                            });
                    });
                });
                
                // Attach event listeners to edit and delete buttons
                grid.querySelectorAll('.mwh-product-edit-btn').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var id = btn.getAttribute('data-id');
                        if (id) editMwhProduct(id);
                    });
                });
                
                grid.querySelectorAll('.mwh-product-remove-btn').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var id = btn.getAttribute('data-id');
                        if (id && confirm('Are you sure you want to delete this product?')) {
                            deleteMwhProduct(id);
                        }
                    });
                });
                
                // Make section titles collapsible
                grid.querySelectorAll('.mwh-section-title').forEach(function(title) {
                    title.addEventListener('click', function() {
                        var section = title.closest('.mwh-section');
                        if (section) {
                            section.classList.toggle('collapsed');
                            title.classList.toggle('collapsed');
                        }
                    });
                });
            }
            
            function editMwhProduct(id) {
                if (!id) return;
                fetch('/api/products/' + id)
                    .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
                    .then(function(result) {
                        if (!result.ok) return;
                        var p = result.data;
                        document.getElementById('mwhEditingProductId').value = id;
                        document.getElementById('mwhProductModalTitle').textContent = 'Edit Product';
                        document.getElementById('mwhSubmitProduct').textContent = 'Save changes';
                        document.getElementById('mwhProductLink').value = p.link || '';
                        document.getElementById('mwhProductWebsiteName').value = p.website_name || '';
                        document.getElementById('mwhProductTitle').value = p.title || '';
                        document.getElementById('mwhProductImageUrl').value = p.image_url || '';
                        document.getElementById('mwhProductPrice').value = p.price || '';
                        document.getElementById('mwhProductCategory').value = p.category || '';
                        document.getElementById('mwhProductRoom').value = p.room || '';
                        document.getElementById('mwhProductTags').value = Array.isArray(p.tags) ? (p.tags || []).join(', ') : (p.tags || '');
                        document.getElementById('mwhProductIsMwh').checked = !!p.is_mwh;
                        if (modal) modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                        if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }
                    })
                    .catch(function(e) { console.error(e); });
            }
            
            function deleteMwhProduct(id) {
                if (!id) return;
                fetch('/api/products/' + id, { method: 'DELETE' })
                    .then(function(r) {
                        if (!r.ok) throw new Error('Failed to delete product');
                        loading.style.display = 'block';
                        return fetch('/api/muswell-hill-products').then(function(r) { return r.json(); });
                    })
                    .then(function(products) {
                        loading.style.display = 'none';
                        var list = Array.isArray(products) ? products : (products && Array.isArray(products.data) ? products.data : []);
                        renderProductList(list);
                    })
                    .catch(function(e) {
                        loading.style.display = 'none';
                        alert('Failed to delete product: ' + (e.message || 'Unknown error'));
                    });
            }
            
            window.editMwhProduct = editMwhProduct;
            window.deleteMwhProduct = deleteMwhProduct;

            function openProductModal() {
                document.getElementById('mwhEditingProductId').value = '';
                document.getElementById('mwhProductModalTitle').textContent = 'Add Product';
                document.getElementById('mwhSubmitProduct').textContent = 'Add Product';
                if (modal) modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }
            }
            function closeProductModal() {
                if (modal) modal.style.display = 'none';
                document.body.style.overflow = '';
                if (form) form.reset();
                document.getElementById('mwhEditingProductId').value = '';
                document.getElementById('mwhProductModalTitle').textContent = 'Add Product';
                document.getElementById('mwhSubmitProduct').textContent = 'Add Product';
                if (statusEl) statusEl.style.display = 'none';
            }

            if (document.getElementById('mwhAddProductBtn')) {
                document.getElementById('mwhAddProductBtn').addEventListener('click', openProductModal);
            }
            if (document.querySelector('.close-mwh-product-modal')) {
                document.querySelector('.close-mwh-product-modal').addEventListener('click', closeProductModal);
            }
            if (document.getElementById('mwhCancelProduct')) {
                document.getElementById('mwhCancelProduct').addEventListener('click', closeProductModal);
            }
            var fetchPreviewBtn = document.getElementById('mwhFetchPreviewBtn');
            var linkInput = document.getElementById('mwhProductLink');
            if (fetchPreviewBtn && linkInput) {
                fetchPreviewBtn.addEventListener('click', function() {
                    var url = (linkInput.value || '').trim();
                    if (!url) return;
                    fetchPreviewBtn.disabled = true;
                    fetchPreviewBtn.textContent = 'Fetching...';
                    fetch('/api/products/preview?url=' + encodeURIComponent(url))
                        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
                        .then(function(result) {
                            fetchPreviewBtn.disabled = false;
                            fetchPreviewBtn.textContent = 'Fetch from link';
                            if (result.ok && result.data) {
                                var d = result.data;
                                if (d.title) document.getElementById('mwhProductTitle').value = d.title;
                                if (d.image_url) document.getElementById('mwhProductImageUrl').value = d.image_url;
                                if (d.website_name) document.getElementById('mwhProductWebsiteName').value = d.website_name;
                                if (d.price) document.getElementById('mwhProductPrice').value = d.price;
                            }
                        })
                        .catch(function() {
                            fetchPreviewBtn.disabled = false;
                            fetchPreviewBtn.textContent = 'Fetch from link';
                        });
                });
            }
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var link = (document.getElementById('mwhProductLink').value || '').trim();
                    if (!link) {
                        if (statusEl) { statusEl.textContent = 'Link is required.'; statusEl.style.display = 'block'; statusEl.className = 'upload-status error'; }
                        return;
                    }
                    var tagsStr = (document.getElementById('mwhProductTags').value || '').trim();
                    var tags = tagsStr ? tagsStr.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];
                    var isMwhEl = document.getElementById('mwhProductIsMwh');
                    var isMwh = isMwhEl ? isMwhEl.checked : false;
                    var payload = {
                        link: link,
                        title: (document.getElementById('mwhProductTitle').value || '').trim() || null,
                        image_url: (document.getElementById('mwhProductImageUrl').value || '').trim() || null,
                        price: (document.getElementById('mwhProductPrice').value || '').trim() || null,
                        category: (document.getElementById('mwhProductCategory').value || '').trim() || null,
                        room: (document.getElementById('mwhProductRoom').value || '').trim() || null,
                        website_name: (document.getElementById('mwhProductWebsiteName').value || '').trim() || null,
                        tags: tags,
                        is_mwh: isMwh
                    };
                    var submitBtn = document.getElementById('mwhSubmitProduct');
                    var editId = (document.getElementById('mwhEditingProductId').value || '').trim();
                    if (submitBtn) submitBtn.disabled = true;
                    if (statusEl) { statusEl.style.display = 'block'; statusEl.className = 'upload-status loading'; statusEl.textContent = editId ? 'Saving...' : 'Adding...'; }
                    var url = editId ? '/api/products/' + editId : '/api/products';
                    var method = editId ? 'PATCH' : 'POST';
                    fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
                    .then(function(result) {
                        if (submitBtn) submitBtn.disabled = false;
                        if (!result.ok) {
                            if (statusEl) { statusEl.textContent = result.data && result.data.error ? result.data.error : (editId ? 'Failed to save.' : 'Failed to add product'); statusEl.className = 'upload-status error'; statusEl.style.display = 'block'; }
                            return;
                        }
                        if (statusEl) { statusEl.textContent = editId ? 'Saved.' : 'Product added.'; statusEl.className = 'upload-status success'; statusEl.style.display = 'block'; }
                        closeProductModal();
                        loading.style.display = 'block';
                        return fetch('/api/muswell-hill-products').then(function(r) { return r.json(); });
                    }).then(function(products) {
                        loading.style.display = 'none';
                        if (Array.isArray(products)) renderProductList(products);
                    }).catch(function(err) {
                        if (submitBtn) submitBtn.disabled = false;
                        if (statusEl) { statusEl.textContent = err.message || 'Error'; statusEl.className = 'upload-status error'; statusEl.style.display = 'block'; }
                    });
                });
            }

            fetch('/api/muswell-hill-products')
                .then(function(r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(function(products) {
                    loading.style.display = 'none';
                    var list = Array.isArray(products) ? products : (products && Array.isArray(products.data) ? products.data : []);
                    renderProductList(list);
                })
                .catch(function(e) {
                    loading.style.display = 'none';
                    grid.innerHTML = '<p class="error">Failed to load products.</p>';
                });
        })();
    </script>
</body>
</html>
